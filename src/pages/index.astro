---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Primis Nexus — Landing">
  <h1>Primis Nexus</h1>
  <p>פורטל תוכן לשיווק, מדידה ואנליטיקה.</p>

  <!-- קישור פנימי: שולח nav_internal ואז מנווט -->
  <p>
    <a href="/guide/intro"
       onclick="event.preventDefault(); window.__nxNav('internal','/guide/intro')">
      קרא מדריך פתיחה
    </a>
  </p>

  <!-- קישור חיצוני: שולח nav_outbound ואז נפתח בלשונית חדשה -->
  <p>
    <a href="https://primis.co" target="_blank" rel="noopener"
       onclick="event.preventDefault(); window.__nxNav('outbound','https://primis.co')">
      בקר באתר Primis
    </a>
  </p>

  <!-- לינק לדשבורד החי -->
  <p><a href="/nexus-mini"><strong>Mini Dashboard (LIVE)</strong></a></p>

  <!-- סטטוס + כפתורי דיבוג -->
  <p class="muted">API base: <code id="apiBase"></code></p>
  <p id="lastStatus" style="opacity:.8">מוכן לשליחה…</p>
  <p>
    <button id="btnPost">שלח POST</button>
    <button id="btnPixel">שלח PIXEL</button>
  </p>
</Layout>

<script>
  const API_BASE = import.meta.env.PUBLIC_RUN_HOST;
  const elBase = document.getElementById("apiBase");
  const elStat = document.getElementById("lastStatus");
  if (elBase) elBase.textContent = API_BASE || "(MISSING PUBLIC_RUN_HOST)";

  function ok(m){ if(elStat) elStat.innerHTML = '<span style="color:#0a7;font-weight:600">✓</span> ' + m; }
  function er(m){ if(elStat) elStat.innerHTML = '<span style="color:#b00;font-weight:600">✗</span> ' + m; }

  async function sendPayload(payload) {
    if(!API_BASE){ er("חסר PUBLIC_RUN_HOST"); return false; }
    try{
      const r = await fetch(`${API_BASE}/api/events`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        mode: "cors",
        body: JSON.stringify(payload)
      });
      if(!r.ok){ er(`HTTP ${r.status}`); return false; }
      const j = await r.json();
      ok(`נשלח! id=${j.id || "ok"}`);
      return true;
    }catch(e){ console.error(e); er("Failed to send (CORS/Network)"); return false; }
  }

  // דיבוג: POST/PIXEL
  document.getElementById("btnPost")?.addEventListener("click", () =>
    sendPayload({ click_id: crypto.randomUUID(), payload:{ type:"from_post",  path: location.pathname } })
  );
  document.getElementById("btnPixel")?.addEventListener("click", () =>
    sendPayload({ click_id: crypto.randomUUID(), payload:{ type:"from_pixel", path: location.pathname } })
  );

  // ניווטים עם ירי אירוע לפני התקדמות
  window.__nxNav = async (kind, to) => {
    const type = kind === 'internal' ? 'nav_internal' : 'nav_outbound';
    await sendPayload({ click_id: crypto.randomUUID(), payload:{ type, path: location.pathname, to } });
    if (kind === 'internal') location.href = to;
    else window.open(to, '_blank', 'noopener');
  };
</script>
