---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Primis Nexus — Landing">
  <h1>Primis Nexus</h1>
  <p>פורטל תוכן לשיווק, מדידה ואנליטיקה.</p>

  <!-- קישור לעמוד פנימי: יורה event לפני הניווט -->
  <p>
    <a href="/guide/intro" onclick="event.preventDefault(); (async()=>{const m=await import('/src/lib/nexus.js'); await m.fire('nav_internal',{to:'/guide/intro'}); location.href='/guide/intro';})()">
      קרא מדריך פתיחה
    </a>
  </p>

  <!-- קישור החוצה: יורה event לפני היציאה -->
  <p>
    <a href="https://primis.co" target="_blank" rel="noopener"
       onclick="event.preventDefault(); (async()=>{const m=await import('/src/lib/nexus.js'); await m.fire('nav_outbound',{to:'https://primis.co'}); window.open('https://primis.co','_blank','noopener');})()">
      בקר באתר Primis
    </a>
  </p>
</Layout>

<!-- DEBUG: Shoot events directly to API -->
<p><button id="dbg-post">שלח POST</button> <button id="dbg-pixel">שלח PIXEL</button></p>
<script>
  const API_BASE = import.meta.env.PUBLIC_RUN_HOST;
  const elBase = document.getElementById("apiBase");
  const elStat = document.getElementById("lastStatus");
  elBase && (elBase.textContent = API_BASE || "(MISSING PUBLIC_RUN_HOST)");

  function ok(m){ elStat && (elStat.innerHTML = '<span style="color:#0a7;font-weight:600">✓</span> ' + m); }
  function er(m){ elStat && (elStat.innerHTML = '<span style="color:#b00;font-weight:600">✗</span> ' + m); }

  async function send(kind){
    if(!API_BASE){ er("חסר PUBLIC_RUN_HOST"); return; }
    const payload = (kind === "pixel")
      ? { click_id: crypto.randomUUID(), payload: { type: "from_pixel", path: location.pathname } }
      : { click_id: crypto.randomUUID(), payload: { type: "from_post",  path: location.pathname } };
    try{
      const r = await fetch(`${API_BASE}/api/events`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        mode: "cors",
        body: JSON.stringify(payload)
      });
      if(!r.ok){ er(`HTTP ${r.status}`); return; }
      const j = await r.json();
      ok(`נשלח! id=${j.id || "ok"}`);
    }catch(e){ console.error(e); er("Failed to send (CORS/Network)"); }
  }

  document.getElementById("btnPost")?.addEventListener("click", () => send("post"));
  document.getElementById("btnPixel")?.addEventListener("click", () => send("pixel"));
</script>

